#!/usr/bin/python
# -*- coding: utf-8 -*-

"""
The code is mostly the result of Frédéric Mantegazza with only slight
modifications to allow for my logging structure

Module purpose
==============

Logging

Implements
==========

- DefaultFormatter
- ColorFormatter
- Logger

:author: Frédéric Mantegazza and Colin Kennedy
.. @copyright: (C) 2007-2011 Frédéric Mantegazza
.. @license: CeCILL
"""

__revision__ = "$Id$"

# IMPORT STANDARD LIBRARIES
import logging
import logging.handlers
import StringIO
import traceback
import os.path

# IMPORT THIRD PARTY LIBRARIES
from commons.unseenformatter import UnseenFormatter
from logger.common import config
from logger.common.loggingFormatter import DefaultFormatter, ColorFormatter, \
                                           SpaceFormatter, SpaceColorFormatter
from pysix import six  # Python 2.x/3.x string types checking

logger = None

# IMPORT LOCAL LIBRARIES
from logger.common.dictlogger import LoggerDictBase, \
                                     LOGGER_MESSAGE_CONFIG, \
                                     RE_LOGGER_KEY_MATCH

# from sandbox.regex_integrated_dict_custom_class_0005 import LoggerDictBase, \
#                                                             LOGGER_MESSAGE_CONFIG, \
#                                                             RE_LOGGER_KEY_MATCH

"""
AUTHOR NOTE: Add default key for the formatter:
http://stackoverflow.com/questions/23407295/default-kwarg-values-for-pythons-str-format-method
"""

class LoggerObject(LoggerDictBase):
    """
    Logger object
    """
    def __init__(self, defaultStreamHandler, defaultFileHandler):
        """
        Init object.
        """
        super(LoggerDictBase, self).__init__()  # takes no arguments
        super(LoggerObject, self).__init__(defaultStreamHandler, defaultFileHandler)
        logging.TRACE = logging.DEBUG - 5
        logging.EXCEPTION = logging.ERROR + 5
        logging.raiseExceptions = 0
        logging.addLevelName(logging.TRACE, "TRACE")
        logging.addLevelName(logging.EXCEPTION, "EXCEPTION")

        # FormattersTypeError: must be type, not classobj

        #defaultFormatter = DefaultFormatter(config.LOGGER_FORMAT)
        spaceFormatter = SpaceFormatter(config.LOGGER_FORMAT)
        #colorFormatter = ColorFormatter(config.LOGGER_FORMAT)
        spaceColorFormatter = SpaceColorFormatter(config.LOGGER_FORMAT)

        # Logger
        self.__logger = logging.getLogger('POP2')
        self.__logger.setLevel(logging.TRACE)

        # Handlers
        if defaultStreamHandler:
            stdoutStreamHandler = logging.StreamHandler()
            #stdoutStreamHandler.setFormatter(colorFormatter)
            stdoutStreamHandler.setFormatter(spaceColorFormatter)
            self.__logger.addHandler(stdoutStreamHandler)
        if defaultFileHandler:
            loggerFilename = os.path.join(config.TMP_DIR, config.LOGGER_FILENAME)
            fileHandler = logging.handlers.RotatingFileHandler(loggerFilename, 'w',
                                                               config.LOGGER_MAX_BYTES,
                                                               config.LOGGER_BACKUP_COUNT)
            fileHandler.setFormatter(spaceFormatter)
            self.__logger.addHandler(fileHandler)

    def addStreamHandler(self, stream, formatter=DefaultFormatter):
        """ Add a new stream handler.

        Can be used to register a new GUI handler.

        @param stream: open stream where to write logs
        @type stream: ???

        @param formatter: associated formatter
        @type formatter: L{DefaultFormatter<common.loggingFormatter>}
        """
        handler = logging.StreamHandler(stream)
        handler.setFormatter(formatter(config.LOGGER_FORMAT))
        self.__logger.addHandler(handler)
    def get_value(self, key, args, kwds):
        if isinstance(key, str):
            try:
                return kwds[key]
            except KeyError:
                return key
        else:
            Formatter.get_value(key, args, kwds)
    # end get_value
    def setLevel(self, level):
        """ Change logging level.

        @param level: new level, in ('trace', 'debug', 'info', 'warning', 'error', 'exception', 'critical')
        @type level: str
        """
        loggerLevels = ('trace', 'debug', 'info', 'warning', 'error', 'exception', 'critical')
        if level not in loggerLevels:
            raise ValueError("Logger level must be in %s" % loggerLevels)
        levels = {'trace': logging.TRACE,
                  'debug': logging.DEBUG,
                  'info': logging.INFO,
                  'warning': logging.WARNING,
                  'error': logging.ERROR,
                  'exception': logging.EXCEPTION,
                  'critical': logging.CRITICAL}
        self.__logger.setLevel(levels[level])

    def trace(self, pos, format=None, *args, **kwargs):
        """ Logs a message with level TRACE.

        @param message: message to log
        @type message: string
        """
        if format is None:
            message = self.__getitem__(pos)
        else:
            message = self.__getitem__(pos)
            message = str(message)
            fmt = UnseenFormatter()
            message = fmt.format(message, **format)

        if isinstance(pos, six.string_types):
            # override previous if pos is a regular logging string
            message = pos

        self.__logger.log(logging.TRACE, message, *args, **kwargs)

    def debug(self, pos, format=None, *args, **kwargs):
        """ Logs a message with level DEBUG.

        @param message: message to log
        @type message: string
        """
        if format is None:
            message = self.__getitem__(pos)
        else:
            message = self.__getitem__(pos)
            message = str(message)
            fmt = UnseenFormatter()
            message = fmt.format(message, **format)

        if isinstance(pos, six.string_types):
            # override previous if pos is a regular logging string
            message = pos

        self.__logger.debug(message, *args, **kwargs)

    def info(self, pos, format=None, *args, **kwargs):
        """ Logs a message with level INFO.

        @param message: message to log
        @type message: string
        """

        if format is None:
            message = self.__getitem__(pos)
        else:
            message = self.__getitem__(pos)
            message = str(message)
            fmt = UnseenFormatter()
            message = fmt.format(message, **format)

        if isinstance(pos, six.string_types):
            # override previous if pos is a regular logging string
            message = pos

        self.__logger.info(message, *args, **kwargs)

    def warning(self, pos, format=None, *args, **kwargs):
        """ Logs a message with level WARNING.

        @param message: message to log
        @type message: string
        """
        if format is None:
            message = self.__getitem__(pos)
        else:
            message = self.__getitem__(pos)
            message = str(message)
            fmt = UnseenFormatter()
            message = fmt.format(message, **format)

        if isinstance(pos, six.string_types):
            # override previous if pos is a regular logging string
            message = pos

        self.__logger.warning(message, *args, **kwargs)

    def error(self, pos, format=None, *args, **kwargs):
        """ Logs a message with level ERROR.

        @param message: message to log
        @type message: string
        """
        if format is None:
            message = self.__getitem__(pos)
        else:
            message = self.__getitem__(pos)
            message = str(message)
            fmt = UnseenFormatter()
            message = fmt.format(message, **format)

        if isinstance(pos, six.string_types):
            # override previous if pos is a regular logging string
            message = pos

        self.__logger.error(message, *args, **kwargs)

    def critical(self, pos, format=None, *args, **kwargs):
        """ Logs a message with level CRITICAL.

        @param message: message to log
        @type message: string
        """
        if format is None:
            message = self.__getitem__(pos)
        else:
            message = self.__getitem__(pos)
            message = str(message)
            fmt = UnseenFormatter()
            message = fmt.format(message, **format)

        if isinstance(pos, six.string_types):
            # override previous if pos is a regular logging string
            message = pos

        self.__logger.critical(message, *args, **kwargs)

    def exception(self, pos, debug=False, format=None, *args, **kwargs):
        """ Logs a message within an exception.

        @param message: message to log
        @type message: string

        @param debug: flag to log exception on DEBUG level instead of EXCEPTION one
        @type debug: bool
        """
        kwargs['exc_info'] = True
        message = self.__getitem__(pos)
        message = str(message)
        fmt = UnseenFormatter()
        message = fmt.format(message, **format)

        if debug:
            if isinstance(pos, six.string_types):
                message = pos

            self.debug(message, *args, **kwargs)
        else:
            if isinstance(pos, six.string_types):
                message = pos

            self.log(logging.EXCEPTION, message, *args, **kwargs)

    def log(self, level, pos, message, *args, **kwargs):
        """ Logs a message with given level.

        @param level: log level to use
        @type level: int

        @param message: message to log
        @type message: string
        """
        message = self.__getitem__(pos)
        message = str(message)
        fmt = UnseenFormatter()
        message = fmt.format(message, **format)

        if isinstance(pos, six.string_types):
            # override previous if pos is a regular logging string
            message = pos

        self.__logger.log(level, message, *args, **kwargs)

    def getTraceback(self):
        """ Return the complete traceback.

        Should be called in an except statement.
        """
        tracebackString = StringIO.StringIO()
        traceback.print_exc(file=tracebackString)
        message = tracebackString.getvalue().strip()
        tracebackString.close()
        return message

    def shutdown(self):
        """ Shutdown the logging service.
        """
        logging.shutdown()

# Logger factory
def Logger(defaultStreamHandler=True, defaultFileHandler=True):
    global logger
    if logger is None:
        logger = LoggerObject(defaultStreamHandler, defaultFileHandler)

    return logger

def init_logger():
    logger = Logger(RE_LOGGER_KEY_MATCH, LOGGER_MESSAGE_CONFIG)
    return logger
# end init_logger

def main():
    """
    dictNew = LoggerDictBase(RE_LOGGER_KEY_MATCH, LOGGER_MESSAGE_CONFIG)

    print dictNew['AIE3000', "Match_True"].format(name="Joe")
    """
    logger = Logger(RE_LOGGER_KEY_MATCH, LOGGER_MESSAGE_CONFIG)
    # logger.debug(['AIE3000', "Match_True"], {'name':'Joe'})
    logger.debug(['AIE1000', "Match_True"], {'name':'Joe'})
# end main

if __name__ == "__main__":
    main()
