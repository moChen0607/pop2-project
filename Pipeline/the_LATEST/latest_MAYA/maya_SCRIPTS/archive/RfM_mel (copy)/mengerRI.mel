
global proc mengerRI() {
// Get the name of the shape node
string $shapeNode = `rman ctxGetObject`;
string $parents[] = `listRelatives -parent $shapeNode`;
string $tformNode = $parents[0];

// The node may hava a number in its name that we can use 
// to set the random number generator
int	$nodeNumber = `match "[0-9]+" $shapeNode`;	
if($nodeNumber != "") {
	seed(int($nodeNumber));
	}
// Bounding box...
float $bb_width =  `getAttr ($shapeNode + ".boundingBoxSizeX")`;
float $bb_height = `getAttr ($shapeNode + ".boundingBoxSizeY")`;
float $bb_depth =  `getAttr ($shapeNode + ".boundingBoxSizeZ")`;

string $attr;
$attr = `rmanGetAttrName "menger_depth"`;
$attr = `rmanGetFullSharedGeometricAttrName $shapeNode $attr`;
int $menger_depth = `getAttr $attr`;

$attr = `rmanGetAttrName "menger_freq"`;
$attr = `rmanGetFullSharedGeometricAttrName $shapeNode $attr`;
float $menger_freq = `getAttr $attr`;

$attr = `rmanGetAttrName "menger_amp"`;
$attr = `rmanGetFullSharedGeometricAttrName $shapeNode $attr`;
float $menger_amp = `getAttr $attr`;

$attr = `rmanGetAttrName "menger_max_amp"`;
$attr = `rmanGetFullSharedGeometricAttrName $shapeNode $attr`;
float $menger_max_amp = `getAttr $attr`;

$attr = `rmanGetAttrName "menger_holes"`;
$attr = `rmanGetFullSharedGeometricAttrName $shapeNode $attr`;
int $menger_holes = `getAttr $attr`;

// Get the coordinates of two of the vertices of our proxy object
float $v0[] = `pointPosition -local ($tformNode + ".vtx[0]")`;
float $v3[] = `pointPosition -local ($tformNode + ".vtx[3]")`;

// Use of Pixar's custom RenderMan Studio====================
python("from menger2d_rman import Menger2D_Rman");
string $rectangle = "[" + $v0[0] + "," + $v0[1] + "," + $v0[2] + "," + 
                          $v3[0] + "," + $v3[1] + "," + $v3[2] + "]";

//string $rectangle = "[-1, 0, -1, 1, 0.0, 1]";
python("menger = Menger2D_Rman(" + $rectangle + "," + $menger_depth + ")");
python("menger.writePolygons('/home/ckenne24/menger.rib', " + 
		$menger_freq + "," +
		$menger_amp  + "," +
		$menger_max_amp + ")");

RiReadArchive("/home/ckenne24/menger.rib");

// Make the proxy object inactive
RiAttribute "visibility" "int camera" 0;
RiAttribute "visibility" "int indirect" 0;
RiAttribute "visibility" "int transmission" 0;
}

