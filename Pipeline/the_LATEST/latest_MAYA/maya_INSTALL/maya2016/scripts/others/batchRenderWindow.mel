// Copyright (C) 1997-2014 Autodesk, Inc., and/or its licensors.
// All rights reserved.
//
// The coded instructions, statements, computer programs, and/or related
// material (collectively the "Data") in these files contain unpublished
// information proprietary to Autodesk, Inc. ("Autodesk") and/or its licensors,
// which is protected by U.S. and Canadian federal copyright law and by
// international treaties.
//
// The Data is provided for use exclusively by You. You have the right to use,
// modify, and incorporate this Data into other products for purposes authorized 
// by the Autodesk software license agreement, without fee.
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND. AUTODESK
// DOES NOT MAKE AND HEREBY DISCLAIMS ANY EXPRESS OR IMPLIED WARRANTIES
// INCLUDING, BUT NOT LIMITED TO, THE WARRANTIES OF NON-INFRINGEMENT,
// MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE, OR ARISING FROM A COURSE 
// OF DEALING, USAGE, OR TRADE PRACTICE. IN NO EVENT WILL AUTODESK AND/OR ITS
// LICENSORS BE LIABLE FOR ANY LOST REVENUES, DATA, OR PROFITS, OR SPECIAL,
// DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES, EVEN IF AUTODESK AND/OR ITS
// LICENSORS HAS BEEN ADVISED OF THE POSSIBILITY OR PROBABILITY OF SUCH DAMAGES.

global int $localHostRenderStatus = 0;
global int $gNumProcessorsForBatchRender = 0;
global string $remoteMachineNameToRender = "";

global proc updateHowManyProcs()
{
	global int $gNumProcessorsForBatchRender;
	int $enabled;
	if (`checkBoxGrp -q -v1 useAllProcs`) {
		$enabled = false;
		$gNumProcessorsForBatchRender = 0;
	} else {
		$enabled = true;
		$gNumProcessorsForBatchRender = `intFieldGrp -q -v1 howManyProcs`;
	}
	intFieldGrp -edit -enable $enabled howManyProcs;
	batchRender -n $gNumProcessorsForBatchRender;
}

global proc updateBatchRenderWindowTitle()
{
	global string $gBatchRenderWindow;

	if (`window -q -exists $gBatchRenderWindow`) {

		string $title;
		if (`getAttr "defaultRenderGlobals.animation"`) {
			$title = (uiRes("m_batchRenderWindow.kBtachRenderAnimation"));
		} else {
			$title = (uiRes("m_batchRenderWindow.kBatchRenderFrame"));
		}

    	window -edit -t $title $gBatchRenderWindow;
	}
}

global proc updateBatchRenderOptionsWindow()
{
    string $curRenderer = currentRenderer();
	string $cmd = `renderer -q -batchRenderOptionsProcedure $curRenderer`;

    if ($cmd == "") {
      string $msg = (uiRes("m_batchRenderWindow.kWarningMessage"));
      $msg = `format -stringArg $curRenderer $msg`;
      warning ($msg);
      $cmd = "nullBatchRenderOptionsWindow";
    }
    eval($cmd);
}

global proc nullBatchRenderOptionsWindow()
{
  // Boilerplate code which also exists in batchRenderWindow() and
  // mentalrayBatchRenderOptionWindow().
  global string $gBatchRenderWindow = "batchRenderWnd";

  if (! `window -q -exists $gBatchRenderWindow`) {
    source "batchRenderWindow";
    createBatchRenderOptionsLayout();
  }
  // Select the correct tab
  tabLayout -edit -selectTab nullBatchOptionsTab batchRenderOptionsTabs;
  showWindow $gBatchRenderWindow;
}

global proc batchRenderWindow()
{
	global int $gNumProcessorsForBatchRender;
	global int $localHostRenderStatus;
	global string $remoteMachineNameToRender;

	global string $gBatchRenderWindow = "batchRenderWnd";

	if (! `window -q -exists $gBatchRenderWindow`) {
		createBatchRenderOptionsLayout();
	}

	//	Set correct parent
	//
	setParent mayaSoftwareBatchOptionsTab;

	if(! `checkBoxGrp -q -exists useAllProcs` ){
		// The layout controls don't exist yet, so create them

    	setUITemplate -pushTemplate DefaultTemplate;

		if (!`about -nt` && !`about -mac`) {
    		radioButtonGrp -nrb 2
    			-label (uiRes("m_batchRenderWindow.kRenderingCPU"))
    			-label1 (uiRes("m_batchRenderWindow.kLocal"))
    			-label2 (uiRes("m_batchRenderWindow.kRemote"))
    			-select ($localHostRenderStatus + 1)
    			-cc1 "setLocalOrRemoteRender 0; textFieldGrp -e -enable 0 remoteMachineName"
    			-cc2 "setLocalOrRemoteRender 1; textFieldGrp -e -enable 1 remoteMachineName"
    			localOrRemoteMachine;
    		textFieldGrp
    			-label (uiRes("m_batchRenderWindow.kRemoteMachineName"))
    			-cc "setRemoteRenderMachine"
    			-tx $remoteMachineNameToRender
				-enable ($localHostRenderStatus != 0)
    			remoteMachineName;
    	}

	    checkBoxGrp -numberOfCheckBoxes 1
	    	-label1 (uiRes("m_batchRenderWindow.kUseAllAvailableProcessors"))
	    	-v1 ($gNumProcessorsForBatchRender == 0)
	    	-cc "updateHowManyProcs"
	    	useAllProcs;

	    intFieldGrp -label (uiRes("m_batchRenderWindow.kNumberOfProcessors"))
	    	-cc "updateHowManyProcs"
	    	-v1 $gNumProcessorsForBatchRender
			-enable ($gNumProcessorsForBatchRender != 0)
			howManyProcs;

		setUITemplate -popTemplate;
	}

	// Select the correct tab
	tabLayout -edit -selectTab mayaSoftwareBatchOptionsTab batchRenderOptionsTabs;

	// Change the title of the window
	string $title;
	if (`getAttr "defaultRenderGlobals.animation"`) {
		$title = (uiRes("m_batchRenderWindow.kBatchRenderAnimation2"));
	} else {
		$title = (uiRes("m_batchRenderWindow.kBatchRenderFrame2"));
	}
	window -edit -title $title $gBatchRenderWindow;

	// Change the button command
	button -edit -command "BatchRender" batchRenderButton;

	if ( `about -evalVersion` ) {
		warning( (uiRes("m_batchRenderWindow.kPLELimitation")));
		checkBoxGrp -e -enable false -value1 false useAllProcs;
		intFieldGrp -e -enable false -value1 1 howManyProcs;
    }

	showWindow $gBatchRenderWindow;
}


global proc setRemoteRenderMachine() {
	global string $remoteMachineNameToRender;
	string $remoteName = `textFieldGrp -q -tx remoteMachineName`;
	batchRender -rm $remoteName;
	$remoteMachineNameToRender = $remoteName;
}

global proc setLocalOrRemoteRender(int $status) {
	global int $localHostRenderStatus;
	batchRender -um $status;
	$localHostRenderStatus = $status;
}
